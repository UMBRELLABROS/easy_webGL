<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kamera mit Math.js</title>
    <link href="css/style.css" rel="stylesheet" />
    <script src="js/gl.js"></script>
    <script src="js/geometry.js"></script>
    <script src="js/physics.js"></script>
    <script src="js/math.js"></script>
    <script src="js/functions.js"></script>
    <script src="js/attribute.js"></script>
    <script src="js/uniform.js"></script>
    <script src="js/texture.js"></script>
    <script src="js/program.js"></script>
    <script src="js/baseobject.js"></script>
    <script src="js/triangle.js"></script>
    <script src="js/dynamic.js"></script>
    <script src="js/item.js"></script>
    <script src="js/scene.js"></script>
    <script src="js/vertexshader.js"></script>
    <script src="js/fragmentshader.js"></script>
    <script src="js/world.js"></script>
    <script src="js/prop.js"></script>
    <script src="js/light.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/director.js"></script>
  </head>

  <body>
    <div id="canvas_container"></div>
    <audio src="audio/golf_driver.mp3" crossorigin="anonymous"></audio>

    <div class="slidecontainer">
      rotate
      <input
        type="range"
        min="-0.9"
        max="0.9"
        step="0.02"
        value="0"
        class="slider"
        id="swing"
        onchange="swing(this.value);"
        oninput="swing(this.value);"
      />
      <br />
    </div>

    <div>
      View (side/front)
      <input type="checkbox" id="view" onclick="changeView(this.checked)" />
    </div>
  </body>

  <script>
    "use scrict";

    var audioCtx, audioElement;
    window.addEventListener("load", function() {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      audioCtx = new AudioContext();
      // load some sound
      audioElement = document.querySelector("audio");
      const track = audioCtx.createMediaElementSource(audioElement);
      // connect our graph
      track.connect(audioCtx.destination);
      // if track ends
      audioElement.addEventListener("ended", () => {}, false);
    });

    function myPlay() {
      // check if context is in suspended state (autoplay policy)
      if (audioCtx.state === "suspended") {
        audioCtx.resume();
      }
      audioElement.play();
    }

    // DEBUG
    var imageCounter = 0;
    var imgFlag = false;

    // Part 1 (getContext)
    // create canvas and gl(webGL)
    var div = $("canvas_container");
    var canvas = dcE("canvas");
    canvas.className = "default_canvas";
    var title = dcE("div");
    canvas.width = div.offsetWidth;
    canvas.height = div.offsetHeight;
    div.appendChild(canvas);
    title.innerHTML = document.title;
    title.className = "div_footer";
    div.appendChild(title);

    var terrain = Geometry.terrain({
      radius: 1000,
      rows: 10,
      cols: 10,
      shiftPoints: [
        [0, 0, [0, 224, 0]],
        [1, 0, [0, 162, 0]],
        [2, 0, [0, 324, 0]],
        [3, 0, [0, 320, 0]],
        [4, 0, [0, 188, 0]],
        [5, 0, [0, 199, 0]],
        [6, 0, [0, 250, 0]],
        [7, 0, [0, 81, 0]],
        [8, 0, [0, 213, 0]],
        [9, 0, [0, 206, 0]],
        [10, 0, [0, 121, 0]],
        [0, 1, [0, 165, 0]],
        [1, 1, [0, 90, 0]],
        [6, 1, [0, 56, 0]],
        [7, 1, [4, 74, 56]],
        [8, 1, [8, 55, -60]],
        [9, 1, [0, 33, 0]],
        [10, 1, [0, 156, 0]],
        [0, 2, [0, 129, 0]],
        [1, 2, [0, 70, 0]],
        [2, 2, [60, 1, 40]],
        [3, 2, [20, 0, -24]],
        [4, 2, [28, 0, -20]],
        [6, 2, [52, 0, 24]],
        [7, 2, [60, 0, 0]],
        [8, 2, [0, 121, 0]],
        [9, 2, [-48, 0, 8]],
        [10, 2, [0, 90, 0]],
        [0, 3, [0, 0, 0]],
        [1, 3, [0, 50, 0]],
        [2, 3, [40, 5, -12]],
        [3, 3, [0, 3, 0]],
        [4, 3, [0, 3, 0]],
        [5, 3, [0, 3, 0]],
        [6, 3, [28, 0, 12]],
        [7, 3, [52, 0, 32]],
        [8, 3, [40, 0, 80]],
        [9, 3, [-24, 0, 72]],
        [10, 3, [0, 85, 0]],
        [0, 4, [0, 154, 0]],
        [2, 4, [24, 5, 12]],
        [3, 4, [36, 0, -20]],
        [4, 4, [52, 0, -20]],
        [5, 4, [76, 0, -32]],
        [6, 4, [0, 6, 0]],
        [7, 4, [0, 3, 0]],
        [8, 4, [4, 0, 44]],
        [2, 5, [8, 0, -48]],
        [3, 5, [0, 59, 0]],
        [4, 5, [0, 232, 0]],
        [5, 5, [72, 0, 0]],
        [6, 5, [0, 6, 0]],
        [8, 5, [0, 8, 0]],
        [0, 6, [0, 118, 0]],
        [1, 6, [0, 66, 0]],
        [2, 6, [36, 0, -12]],
        [3, 6, [-8, 132, 32]],
        [4, 6, [0, 272, 0]],
        [5, 6, [56, 0, 12]],
        [1, 7, [0, 51, 0]],
        [2, 7, [68, 0, 0]],
        [3, 7, [0, 77, 0]],
        [4, 7, [0, 158, 0]],
        [5, 7, [32, 0, 12]],
        [7, 7, [0, 8, 0]],
        [2, 8, [112, 0, 24]],
        [3, 8, [40, 0, 36]],
        [4, 8, [4, 0, 52]],
        [5, 8, [8, 0, 88]],
        [1, 9, [0, 16, 0]],
        [3, 9, [0, 5, 0]]
      ],
      rigidities: [
        [3, 2, 0.75],
        [4, 2, 0.6],
        [5, 2, 0.6],
        [6, 2, 0.6],
        [7, 2, 0.9],

        [6, 3, 0.6],
        [7, 3, 0.6],

        [3, 4, 0.9],
        [4, 4, 0.9],
        [6, 4, 0.6],
        [7, 4, 0.6],

        [2, 5, 0.9],
        [3, 5, 0.9],
        [4, 5, 0.9],
        [6, 5, 0.6],
        [7, 5, 0.6],

        [2, 6, 0.9],
        [3, 6, 0.9],
        [4, 6, 0.9],
        [6, 6, 0.6],
        [7, 6, 0.6]
      ]
    });

    var sphereLight = Geometry.sphere({ radius: 50 });

    var geoHead = Geometry.sphere({ radius: 0.12 });
    // Body
    var geoLowerBody = Geometry.cube({
      dimension: { x: 0.15, y: 0.2, z: 0.25 }
    });
    var geoUpperBody = Geometry.cube({
      dimension: { x: 0.18, y: 0.3, z: 0.3 }
    });

    // Arms
    var geoShoulder = Geometry.sphere({ radius: 0.05 });
    var geoElbow = Geometry.sphere({ radius: 0.04 });
    var geoArm = Geometry.cube({
      dimension: { x: 0.07, y: 0.3, z: 0.07 }
    });
    var geoHand = Geometry.sphere({ radius: 0.04 });

    // Legs
    var geoPelvis = Geometry.sphere({ radius: 0.1 });
    var geoUpperLeg = Geometry.cube({
      dimension: { x: 0.14, y: 0.35, z: 0.14 }
    });
    var geoKnee = Geometry.sphere({ radius: 0.07 });
    var geoLowerLeg = Geometry.cube({
      dimension: { x: 0.1, y: 0.5, z: 0.1 }
    });

    // golf club
    var geoShaft = Geometry.cube({
      dimension: { x: 0.01, y: 0.9, z: 0.01 }
    });
    var geoClubHead = Geometry.cube({
      dimension: { x: 0.08, y: 0.05, z: 0.02 }
    });

    var director = new DirectorController(canvas);

    var camera1 = new Camera();
    camera1.type = CameraKind.LOOKAT;
    camera1.dynamic.position = [500, 1.7, -502.5];
    camera1.dynamic.lookAt = [500, 1.7, -500];
    camera1.far = 2600;

    var surface = new PropService({
      image: "misc/golfplane.jpg",
      geometry: terrain,
      position: [0, 0, 0],
      physics: {
        movable: false,
        rigidity: 0.3
      }
    });

    // golf club
    clubHead = new PropService({
      geometry: geoClubHead,
      color: [0.7, 0.7, 0.7, 1],
      position: [0.05, -0.45, 0]
    });
    shaft = new PropService({
      geometry: geoShaft,
      color: [0.7, 0.7, 0.7, 1],
      position: [0, -0.45, 0],
      children: [clubHead]
    });

    // Arms
    hands = new PropService({
      geometry: geoHand,
      color: [0.384, 0.339, 0.277, 1],
      position: [0, -0.15, 0],
      children: [shaft]
    });
    hands.dynamic.orientation = [-0.5, 0, 0];

    rightLowerArm = new PropService({
      geometry: geoArm,
      color: [0.98, 0.84, 0.83, 1],
      position: [0, -0.15, 0],
      children: [hands]
    });
    leftLowerArm = new PropService({
      geometry: geoArm,
      color: [0.98, 0.84, 0.83, 1],
      position: [0, -0.15, 0]
    });
    leftElbow = new PropService({
      geometry: geoElbow,
      color: [0.98, 0.84, 0.83, 1],
      position: [0, -0.15, 0],
      children: [leftLowerArm]
    });
    leftElbow.dynamic.orientation = [0, 0, -0.1];

    rightElbow = new PropService({
      geometry: geoElbow,
      color: [0.98, 0.84, 0.83, 1],
      position: [0, -0.15, 0],
      children: [rightLowerArm]
    });
    rightElbow.dynamic.orientation = [0, 0, -0.1];

    leftUpperArm = new PropService({
      geometry: geoArm,
      color: [0, 0.5, 1, 1],
      position: [0, -0.15, 0],
      children: [leftElbow]
    });
    rightUpperArm = new PropService({
      geometry: geoArm,
      color: [0, 0.5, 1, 1],
      position: [0, -0.15, 0],
      children: [rightElbow]
    });

    leftShoulder = new PropService({
      geometry: geoShoulder,
      color: [0, 0.5, 1, 1],
      position: [0, 0.1, 0.2],
      children: [leftUpperArm]
    });
    leftShoulder.dynamic.orientation = [0, 0, -0.5];
    rightShoulder = new PropService({
      geometry: geoShoulder,
      color: [0, 0.5, 1, 1],
      position: [0, 0.1, -0.2],
      children: [rightUpperArm]
    });
    rightShoulder.dynamic.orientation = [0, 0, -0.5];

    // Legs
    rightLowerLeg = new PropService({
      geometry: geoLowerLeg,
      color: [0.98, 0.84, 0.83, 1],
      position: [0, -0.2, 0]
    });
    leftLowerLeg = new PropService({
      geometry: geoLowerLeg,
      color: [0.98, 0.84, 0.83, 1],
      position: [0, -0.2, 0]
    });
    rightKnee = new PropService({
      geometry: geoKnee,
      color: [0.98, 0.84, 0.83, 1],
      position: [0, -0.2, 0],
      children: [rightLowerLeg]
    });
    rightKnee.dynamic.orientation = [0, 0, 0.2];
    leftKnee = new PropService({
      geometry: geoKnee,
      color: [0.98, 0.84, 0.83, 1],
      position: [0, -0.2, 0],
      children: [leftLowerLeg]
    });
    leftKnee.dynamic.orientation = [0, 0, 0.2];

    rightUpperLeg = new PropService({
      geometry: geoUpperLeg,
      color: [0, 0, 0, 1],
      position: [0, -0.25, 0],
      children: [rightKnee]
    });
    leftUpperLeg = new PropService({
      geometry: geoUpperLeg,
      color: [0, 0, 0, 1],
      position: [0, -0.25, 0],
      children: [leftKnee]
    });

    rightPelvis = new PropService({
      geometry: geoPelvis,
      color: [0, 0, 0, 1],
      position: [-0.03, -0.15, -0.08],
      children: [rightUpperLeg]
    });
    rightPelvis.dynamic.orientation = [0, 0, -0.1];
    leftPelvis = new PropService({
      geometry: geoPelvis,
      color: [0, 0, 0, 1],
      position: [-0.03, -0.15, 0.08],
      children: [leftUpperLeg]
    });
    leftPelvis.dynamic.orientation = [0, 0, -0.1];

    head = new PropService({
      geometry: geoHead,
      color: [0.98, 0.84, 0.83, 1],
      position: [0.1, 0.25, 0]
    });

    // Body
    upperBody = new PropService({
      geometry: geoUpperBody,
      color: [0, 0.5, 1, 1],
      position: [0, 0.25, 0],
      children: [leftShoulder, rightShoulder, head]
    });

    base = new PropService({
      geometry: geoLowerBody,
      color: [0, 0.5, 1, 1],
      position: [500, 1, -500],
      children: [upperBody, rightPelvis, leftPelvis]
    });

    var light1 = new LightService();
    light1.setKind(LightKind.DIRECT);
    light1.setDirection([0, -0.9, 0.7]);

    var light2 = new LightService();
    light2.setKind(LightKind.POINT);
    light2.position = [300, 1000, -900];
    propLight = new PropService({
      geometry: sphereLight,
      color: [1, 1, 1, 1],
      position: light2.position
    });

    var propC = [];
    propC.push(surface);
    propC.push(base);
    propC.push(propLight);

    var scene = new SceneService(propC, [light1, light2], [camera1]);

    director.addScene([scene]);

    director.action();

    var time = 0;
    function rotateCamera() {
      var t = time / 5000;
      if (t > Math.abs(Math.PI * 2)) time = 0;
      var r = 4;
      var x = r * Math.sin(t) + 500;
      var z = r * Math.cos(t) - 500;
      camera1.dynamic.position = [x, 2.75, z];
      time += 40;
      setTimeout("rotateCamera()", 40);
    }
    //rotateCamera();

    function swing(valueY) {
      base.dynamic.orientation = [0, valueY, 0];
      upperBody.dynamic.orientation = [0, valueY * 0.7, 0];
      // Arms
      rightShoulder.dynamic.orientation = [
        0.26,
        0,
        -0.3 - Math.abs(valueY) / 1
      ];
      rightElbow.dynamic.orientation = [
        0.2 + Math.abs(valueY) / 1,
        0.4,
        -0.1 - Math.abs(valueY) / 1
      ];

      leftShoulder.dynamic.orientation = [
        -0.26,
        0,
        -0.3 - Math.abs(valueY) / 1
      ];
      leftElbow.dynamic.orientation = [
        -0.2 - +Math.abs(valueY) / 1,
        -0.4,
        -0.1 - Math.abs(valueY) / 1
      ];
      hands.dynamic.orientation = [
        -0.5 + Math.abs(valueY) / 1,
        0,
        -Math.abs(valueY) / 1
      ];

      // Legs
      rightPelvis.dynamic.orientation = [0, -valueY * 0.7, -0.1 + valueY / 8];
      leftPelvis.dynamic.orientation = [0, -valueY * 0.7, -0.1 - valueY / 8];
      if (valueY > 0 && !played) {
        myPlay();
        played = true;
      }
      if (valueY < 0 && played) {
        played = false;
      }
    }
    played = false;
    swing(0);

    function changeView(value) {
      if (value) {
        camera1.dynamic.position = [502.5, 1.7, -500];
      } else {
        camera1.dynamic.position = [500, 1.7, -502.5];
      }
    }
  </script>
</html>
